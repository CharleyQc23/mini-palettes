<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini-palettes roses - D√©tail produit</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="images/favicon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="images/favicon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon-192.png">
  <meta name="theme-color" content="#e91e63">
</head>

<body>

<div class="bandeau-taxes">TOUS LES PRIX INCLUENT LES TAXES</div>

<header class="banniere">
  <div class="header-container">
    <div class="logo-texte">
      <a href="index.html">
        <img src="images/MPR_logo_FINAL-vectorise.png" alt="Logo Mini Palettes Roses" class="logo-site">
      </a>
      <div class="texte-site">
        <h1>Mini-palettes roses</h1>
        <p>La boutique des futures Palettes Roses!</p>
      </div>
    </div>
    <nav class="menu-nav">
      <a href="boutique.html" class="nav-link">Boutique</a>
      <a href="a-propos.html" class="nav-link">√Ä propos</a>
      <a href="contact.html" class="nav-link">Contact</a>
    </nav>
  </div>
</header>

<button id="btn-panier" title="Voir le panier">üõí Panier (<span id="nb-items">0</span>)</button>

<div id="sidebar-panier" class="sidebar-closed">
  <button id="btn-fermer-panier">‚úñ</button>
  <h2>Ton panier</h2>
  <ul id="liste-panier"></ul>
  <p><strong>Total : <span id="total">0.00</span> $</strong></p>
  <button id="payer">Proc√©der au paiement</button>
</div>

<main>
  <div class="contenu-produit" id="fiche-produit">
    <h2>Chargement du produit...</h2>
  </div>
</main>

<div id="footer-container"></div>

<script>
  // --- PANIER
  let panier = JSON.parse(localStorage.getItem('panier')) || [];

  function majNbItems() {
    const totalArticles = panier.reduce((acc, item) => acc + (Number(item.quantite) || 0), 0);
    document.getElementById('nb-items').textContent = totalArticles;
  }

  function animationPanier() {
    const compteur = document.getElementById('nb-items');
    const btnPanier = document.getElementById('btn-panier');
    compteur.classList.add('animate');
    btnPanier.classList.add('animate');
    setTimeout(() => {
      compteur.classList.remove('animate');
      btnPanier.classList.remove('animate');
    }, 400);
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function afficherPanier() {
    const liste = document.getElementById('liste-panier');
    liste.innerHTML = '';
    let total = 0;

    panier = panier.map(item => {
      const quant = (item.quantite && Number(item.quantite)) ? Number(item.quantite) : 1;
      const prixUnitaire = item.prixUnitaire !== undefined && !isNaN(Number(item.prixUnitaire))
        ? Number(item.prixUnitaire)
        : (item.prix !== undefined && quant ? Number(item.prix)/quant : 0);
      return { ...item, quantite: quant, prixUnitaire, prix: prixUnitaire * quant };
    });

    if (!panier || panier.length === 0) {
      liste.innerHTML = '<li style="text-align:center; color:#888;">Ton panier est vide üõçÔ∏è</li>';
      document.getElementById('total').textContent = '0.00';
      majNbItems();
      return;
    }

    panier.forEach((item, index) => {
      total += item.prix;
      const li = document.createElement('li');
      li.className = 'ligne-panier';
      li.innerHTML = `
        <div class="ligne-left">
          <div class="nom-produit"><strong>${escapeHtml(item.nom)}</strong></div>
          <div style="font-size:0.85rem; color:#666;">
            ${item.taille ? escapeHtml(item.taille) : ''} ${item.personnalisation ? ' ‚Ä¢ ' + escapeHtml(item.personnalisation) : ''}
          </div>
        </div>
        <div class="ligne-right">
          <div class="quantite-controls">
            <button class="btn-moins" data-index="${index}">‚ûñ</button>
            <input type="number" class="qte-input" data-index="${index}" value="${item.quantite}" min="1" />
            <button class="btn-plus" data-index="${index}">‚ûï</button>
          </div>
          <div class="prix-item">${item.prix.toFixed(2)} $</div>
          <button class="btn-supprimer" data-index="${index}">üóëÔ∏è</button>
        </div>
      `;
      liste.appendChild(li);
    });

    document.querySelectorAll('.btn-plus').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        panier[i].quantite++;
        panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.btn-moins').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        if (panier[i].quantite > 1) {
          panier[i].quantite--;
          panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        } else {
          panier.splice(i, 1);
        }
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.qte-input').forEach(input => {
      input.addEventListener('change', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        let q = parseInt(e.currentTarget.value, 10);
        if (isNaN(q) || q < 1) q = 1;
        if (q > 99) q = 99;
        panier[i].quantite = q;
        panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.btn-supprimer').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        panier.splice(i, 1);
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.getElementById('total').textContent = total.toFixed(2);
    majNbItems();
  }

  // Sidebar
  document.getElementById('btn-panier').addEventListener('click', () => {
    document.getElementById('sidebar-panier').classList.toggle('open');
  });
  document.getElementById('btn-fermer-panier').addEventListener('click', () => {
    document.getElementById('sidebar-panier').classList.remove('open');
  });

  // Paiement Stripe
  document.getElementById('payer').addEventListener('click', async () => {
    if (panier.length === 0) { alert("Ton panier est vide !"); return; }
    try {
      const response = await fetch('https://mini-palettes-roses.onrender.com/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ panier }),
      });
      const data = await response.json();
      if (data.id) {
        const stripe = Stripe('pk_test_51RjVtFPtAYsb0tTKFaXBb3U96XQePm5nInGkVMaubkiqz9tWXLyv2qqQLfLsFQRxUwH2jHzZBp9ZLhA9TR2k1N0a007kRZOPEr');
        await stripe.redirectToCheckout({ sessionId: data.id });
      } else { alert('Erreur lors de la cr√©ation de la session de paiement.'); }
    } catch(e) { console.error(e); alert('Erreur lors du paiement.'); }
  });

  // Champs broderie
  function afficherChampsBroderie() {
    const persoValue = document.getElementById('perso').value;
    const detailsContainer = document.getElementById('details-broderie');
    let contenu = '';
    if (persoValue.includes('NOM')) {
      contenu += `<label for="champ-nom">Nom √† broder :</label><br>
                  <input type="text" id="champ-nom" placeholder="ex: Juliette" /><br><br>`;
    }
    if (persoValue.includes('NUM√âRO')) {
      contenu += `<label for="champ-numero">Num√©ro √† broder :</label><br>
                  <input type="text" id="champ-numero" placeholder="ex: 21" /><br><br>`;
    }
    detailsContainer.innerHTML = contenu;
  }

  // Fiche produit
  const params = new URLSearchParams(window.location.search);
  const idProduit = params.get('id');
  if (idProduit) {
    fetch('produits.json')
      .then(res => res.json())
      .then(produits => {
        if (!produits[idProduit]) return;
        const produit = produits[idProduit];
        const div = document.getElementById('fiche-produit');
        div.innerHTML = `
          <img src="${produit.image}" alt="${escapeHtml(produit.nom)}" />
          <h2>${escapeHtml(produit.nom)}</h2>
          <p><strong>${produit.prix.toFixed(2)} $</strong></p>

          <label for="taille">Choisis une grandeur :</label><br>
          <select id="taille">
            <option value="">-- S√©lectionner --</option>
            <option value="X-Small">X-Small</option>
            <option value="Small">Small</option>
            <option value="Medium">Medium</option>
            <option value="Large">Large</option>
            <option value="X-Large">X-Large</option>
          </select><br><br>

          <label for="perso">Broderie :</label><br>
          <select id="perso">
            <option value="">-- S√©lectionner --</option>
            <option value="Aucune|0">Aucune 0$</option>
            <option value="Broderie NOM|7">NOM +7 $</option>
            <option value="Broderie NUM√âRO|5.5">NUM√âRO +5.5 $</option>
            <option value="Broderie NOM et NUM√âRO|10">NOM et NUM√âRO +10 $</option>
          </select><br><br>

          <div id="details-broderie"></div>

          <label for="quantite">Quantit√© :</label><br>
          <input type="number" id="quantite" name="quantite" min="1" value="1" style="width:60px; padding:0.3rem; border-radius:6px; border:1px solid #ccc;" /><br><br>

          <button id="ajouter-panier" class="btn-ajouter" disabled>Ajouter au panier</button><br>
          <button class="btn-retour" onclick="window.location.href='boutique.html'">‚Üê Retour √† la boutique</button>
        `;

        const selectTaille = document.getElementById('taille');
        const selectPerso = document.getElementById('perso');
        const inputQuantite = document.getElementById('quantite');
        const boutonAjouter = document.getElementById('ajouter-panier');

        function checkReady() {
          const qte = parseInt(inputQuantite.value, 10);
          boutonAjouter.disabled = (!selectTaille.value || !selectPerso.value || !qte || qte < 1);
        }

        selectTaille.addEventListener('change', checkReady);
        selectPerso.addEventListener('change', () => { afficherChampsBroderie(); checkReady(); });
        inputQuantite.addEventListener('input', checkReady);

        boutonAjouter.addEventListener('click', () => {
          const taille = selectTaille.value;
          const [persoText, persoPrix] = selectPerso.value.split('|');
          const quantite = parseInt(inputQuantite.value, 10);
          const prixUnitaire = produit.prix + parseFloat(persoPrix);
          const prixFinal = prixUnitaire * quantite;
          const nomBrode = document.getElementById('champ-nom')?.value || '';
          const numeroBrode = document.getElementById('champ-numero')?.value || '';
          panier.push({
            nom: produit.nom,
            prix: prixFinal,
            taille,
            personnalisation: persoText + (nomBrode ? `: ${nomBrode}` : '') + (numeroBrode ? ` #${numeroBrode}` : ''),
            quantite,
            prixUnitaire
          });
          localStorage.setItem('panier', JSON.stringify(panier));
          afficherPanier();
          animationPanier();
          alert(`Ajout√© : ${produit.nom} (${taille}, ${persoText}) x${quantite} pour ${prixFinal.toFixed(2)} $`);
        });

        checkReady();
      });
  }

  afficherPanier();
  majNbItems();

  // Footer
  fetch('footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer-container').outerHTML = data;
    });
</script>
</body>
</html>
