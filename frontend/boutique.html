<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Palettes Roses - Boutique</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="images/favicon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="images/favicon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon-192.png">
  <meta name="theme-color" content="#e91e63">
  <style>
#galerie-produits {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.produit {
  width: 200px;
  border: 1px solid #eee;
  border-radius: 15px;
  padding: 1rem;
  text-align: center;
  background: #fff0f6;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease;
}
.produit:hover {
  transform: scale(1.02);
}

.produit img {
  width: 100%;
  border-radius: 12px;
}

.lien-produit {
  color: inherit;
  text-decoration: none;
  display: block;
}

.btn-ajouter {
  margin-top: 0.7rem;
  padding: 0.6rem 1rem;
  background-color: var(--rose-fonc√©, #e91e63);
  border: 2px solid transparent;
  color: white;
  border-radius: 30px;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
  transition: background-color 0.3s ease, transform 0.2s ease;
}
.btn-ajouter:hover {
  background-color: #c2185b;
  transform: scale(1.03);
}

.btn-supprimer {
  background-color: white;
  border: 2px solid #c2185b;
  color: #c2185b;
  font-size: 0.85rem;
  font-weight: bold;
  padding: 0.3rem 0.7rem;
  border-radius: 20px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
}
.btn-supprimer:hover {
  background-color: #c2185b;
  color: white;
}

    @keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 1s ease forwards;
}
  </style>
</head>

<!-- üìù Bandeau Cookies -->
<div id="cookie-banner" class="cookie-banner">
  <p>
    Nous utilisons des cookies conform√©ment √† la Loi 25 sur la protection des renseignements personnels des citoyens du Qu√©bec.
    <a href="politique.html" class="cookie-link">En savoir plus</a>
  </p>
  <div class="cookie-buttons">
    <button id="accept-cookies" class="btn-cookie">Accepter</button>
    <button id="refuse-cookies" class="btn-cookie refuse">Seulement les t√©moins n√©cessaires</button>
  </div>
</div>
<script src="cookies.js"></script>

<body>
<div class="bandeau-taxes">
  TOUS LES PRIX INCLUENT LES TAXES
</div>

<header class="banniere">
  <div class="header-container">
    <div class="logo-texte">
      <a href="index.html">
        <img src="images/MPR_logo_FINAL-vectorise.png" alt="Logo Mini Palettes Roses" class="logo-site">
      </a>
      <div class="texte-site">
        <h1>Mini-palettes roses</h1>
        <p>La boutique des futures Palettes Roses!</p>
      </div>
    </div>

    <nav class="menu-nav">
      <a href="index.html" class="nav-link">Accueil</a>
      <a href="a-propos.html" class="nav-link">√Ä propos</a>
      <a href="inscription.html" class="nav-link">Inscription</a>
      <a href="contact.html" class="nav-link">Contact</a>
    </nav>
  </div>
</header>

<button id="btn-panier" title="Voir le panier">üõí  (<span id="nb-items">0</span>)</button>

<div id="sidebar-panier" class="sidebar-closed">
  <button id="btn-fermer-panier">‚úñ</button>
  <h2>Ton panier</h2>
  <ul id="liste-panier"></ul>
  <p><strong>Total : <span id="total">0.00</span> $</strong></p>
  <button id="payer">Proc√©der au paiement</button>
</div>

<main  class="fade-in">
  <section id="galerie-produits" class="galerie"></section>
</main>

<script>
  // --- PANIER
  let panier = JSON.parse(localStorage.getItem('panier')) || [];

  // --- Mise √† jour du nombre d'articles (toutes quantit√©s)
  function majNbItems() {
    const totalArticles = panier.reduce((acc, item) => acc + (Number(item.quantite) || 0), 0);
    document.getElementById('nb-items').textContent = totalArticles;
  }

  // --- Animation compteur et bouton
  function animationPanier() {
    const compteur = document.getElementById('nb-items');
    const btnPanier = document.getElementById('btn-panier');
    compteur.classList.add('animate');
    btnPanier.classList.add('animate');
    setTimeout(() => {
      compteur.classList.remove('animate');
      btnPanier.classList.remove('animate');
    }, 400);
  }

  // --- √âchapper le HTML pour s√©curit√©
  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // --- Afficher le panier
  function afficherPanier() {
    const liste = document.getElementById('liste-panier');
    liste.innerHTML = '';
    let total = 0;

    // Normaliser panier
    panier = panier.map(item => {
      const quant = (item.quantite && Number(item.quantite)) ? Number(item.quantite) : 1;
      let prixUnitaire = (item.prixUnitaire !== undefined && !isNaN(Number(item.prixUnitaire)))
        ? Number(item.prixUnitaire)
        : (item.prix !== undefined && quant ? Number(item.prix)/quant : 0);
      return { ...item, quantite: quant, prixUnitaire: prixUnitaire, prix: prixUnitaire * quant };
    });

    if (!panier || panier.length === 0) {
      liste.innerHTML = '<li style="text-align:center; color:#888;">Ton panier est vide üõçÔ∏è</li>';
      document.getElementById('total').textContent = '0.00';
      majNbItems();
      return;
    }

    panier.forEach((item, index) => {
      total += item.prix;
      const li = document.createElement('li');
      li.className = 'ligne-panier';
      li.innerHTML = `
        <div class="ligne-left">
          <div class="nom-produit"><strong>${escapeHtml(item.nom)}</strong></div>
          <div style="font-size:0.85rem; color:#666;">
            ${item.taille ? escapeHtml(item.taille) : ''} ${item.personnalisation ? ' ‚Ä¢ ' + escapeHtml(item.personnalisation) : ''}
          </div>
        </div>

        <div class="ligne-right">
          <div class="quantite-controls">
            <button class="btn-moins" data-index="${index}" aria-label="R√©duire la quantit√©">‚ûñ</button>
            <input type="number" class="qte-input" data-index="${index}" value="${item.quantite}" min="1" />
            <button class="btn-plus" data-index="${index}" aria-label="Ajouter une quantit√©">‚ûï</button>
          </div>

          <div class="prix-item">${item.prix.toFixed(2)} $</div>

          <button class="btn-supprimer" data-index="${index}" aria-label="Supprimer">üóëÔ∏è</button>
        </div>
      `;
      liste.appendChild(li);
    });

    // --- Boutons + / - / input / supprimer
    document.querySelectorAll('.btn-plus').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        panier[i].quantite++;
        panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.btn-moins').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        if (panier[i].quantite > 1) {
          panier[i].quantite--;
          panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        } else {
          panier.splice(i, 1);
        }
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.qte-input').forEach(input => {
      input.addEventListener('change', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        let q = parseInt(e.currentTarget.value, 10);
        if (isNaN(q) || q < 1) q = 1;
        if (q > 99) q = 99;
        panier[i].quantite = q;
        panier[i].prix = panier[i].quantite * panier[i].prixUnitaire;
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.querySelectorAll('.btn-supprimer').forEach(btn => {
      btn.addEventListener('click', e => {
        const i = parseInt(e.currentTarget.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        panier.splice(i, 1);
        localStorage.setItem('panier', JSON.stringify(panier));
        afficherPanier();
      });
    });

    document.getElementById('total').textContent = total.toFixed(2);
    majNbItems();
  }

  // --- Sidebar panier
  document.getElementById('btn-panier').addEventListener('click', () => {
    document.getElementById('sidebar-panier').classList.toggle('open');
  });
  document.getElementById('btn-fermer-panier').addEventListener('click', () => {
    document.getElementById('sidebar-panier').classList.remove('open');
  });

  // --- Paiement Stripe
  document.getElementById('payer').addEventListener('click', async () => {
    if (panier.length === 0) {
      alert("Ton panier est vide !");
      return;
    }

    try {
      const response = await fetch('https://mini-palettes-roses.onrender.com/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ panier }),
      });
      const data = await response.json();
      if (data.id) {
        const stripe = Stripe('pk_test_51RlJVvRajgyqcAklwomlIeHZmbovio5dknAXCQ2mCK7lzDjT8117DNBaFRRbu9S7xtruMHxerqNviVuYvJHZafx100ORhbe9DB');
        await stripe.redirectToCheckout({ sessionId: data.id });
      } else {
        alert('Erreur lors de la cr√©ation de la session de paiement.');
      }
    } catch (error) {
      console.error('Erreur paiement:', error);
      alert('Erreur lors du paiement. Regarde la console.');
    }
  });

  // --- Affichage des champs broderie selon la s√©lection
  function afficherChampsBroderie() {
    const persoValue = document.getElementById('perso').value;
    const detailsContainer = document.getElementById('details-broderie');
    if (!detailsContainer) return;
    let contenu = '';
    if (persoValue.includes('NOM')) {
      contenu += `<label for="champ-nom">Nom √† broder :</label><br>
                  <input type="text" id="champ-nom" placeholder="ex: Juliette" /><br><br>`;
    }
    if (persoValue.includes('NUM√âRO')) {
      contenu += `<label for="champ-numero">Num√©ro √† broder :</label><br>
                  <input type="text" id="champ-numero" placeholder="ex: 21" /><br><br>`;
    }
    detailsContainer.innerHTML = contenu;
  }

  // --- Chargement fiche produit
  const params = new URLSearchParams(window.location.search);
  const idProduit = params.get('id');

  if (idProduit) {
    fetch('produits.json')
      .then(res => res.json())
      .then(produits => {
        if (!produits[idProduit]) return;

        const produit = produits[idProduit];
        const div = document.getElementById('fiche-produit');
        div.innerHTML = `
          <img src="${produit.image}" alt="${escapeHtml(produit.nom)}" />
          <h2>${escapeHtml(produit.nom)}</h2>
          <p><strong>${produit.prix.toFixed(2)} $</strong></p>

          <label for="taille">Choisis une grandeur :</label><br>
          <select id="taille">
            <option value="">-- S√©lectionner --</option>
            <option value="X-Small">X-Small</option>
            <option value="Small">Small</option>
            <option value="Medium">Medium</option>
            <option value="Large">Large</option>
            <option value="X-Large">X-Large</option>
          </select><br><br>

          <label for="perso">Broderie :</label><br>
          <select id="perso">
            <option value="">-- S√©lectionner --</option>
            <option value="Aucune|0">Aucune 0$</option>
            <option value="Broderie NOM|7">NOM +7 $</option>
            <option value="Broderie NUM√âRO|5.5">NUM√âRO +5.5 $</option>
            <option value="Broderie NOM et NUM√âRO|10">NOM et NUM√âRO +10 $</option>
          </select><br><br>

          <div id="details-broderie"></div>

          <label for="quantite">Quantit√© :</label><br>
          <input type="number" id="quantite" name="quantite" min="1" value="1" style="width:60px; padding:0.3rem; border-radius:6px; border:1px solid #ccc;" /><br><br>

          <button id="ajouter-panier" class="btn-ajouter" disabled>Ajouter au panier</button><br>
          <button class="btn-retour" onclick="window.location.href='boutique.html'">‚Üê Retour √† la boutique</button>
        `;

        const selectTaille = document.getElementById('taille');
        const selectPerso = document.getElementById('perso');
        const inputQuantite = document.getElementById('quantite');
        const boutonAjouter = document.getElementById('ajouter-panier');

        function checkReady() {
          const qte = parseInt(inputQuantite.value, 10);
          boutonAjouter.disabled = (!selectTaille.value || !selectPerso.value || !qte || qte < 1);
        }

        selectTaille.addEventListener('change', checkReady);
        selectPerso.addEventListener('change', () => {
          afficherChampsBroderie();
          checkReady();
        });
        inputQuantite.addEventListener('input', checkReady);

        boutonAjouter.addEventListener('click', () => {
          const taille = selectTaille.value;
          const [persoText, persoPrix] = selectPerso.value.split('|');
          const quantite = parseInt(inputQuantite.value, 10);
          const prixUnitaire = produit.prix + parseFloat(persoPrix);
          const prixFinal = prixUnitaire * quantite;

          const nomBrode = document.getElementById('champ-nom')?.value || '';
          const numeroBrode = document.getElementById('champ-numero')?.value || '';

          panier.push({
            nom: produit.nom,
            prix: prixFinal,
            taille: taille,
            personnalisation: persoText + (nomBrode ? `: ${nomBrode}` : '') + (numeroBrode ? ` #${numeroBrode}` : ''),
            quantite: quantite,
            prixUnitaire: prixUnitaire
          });

          localStorage.setItem('panier', JSON.stringify(panier));
          afficherPanier();
          animationPanier();
          alert(`Ajout√© : ${produit.nom} (${taille}, ${persoText}) x${quantite} pour ${prixFinal.toFixed(2)} $`);
        });

        checkReady();
      });
  }

  afficherPanier();
  majNbItems();

  // --- Affichage des produits dans la galerie
fetch('produits.json')
  .then(res => res.json())
  .then(produits => {
    const galerie = document.getElementById('galerie-produits');
    galerie.innerHTML = '';

    Object.keys(produits).forEach(id => {
      const p = produits[id];
      const div = document.createElement('div');
      div.className = 'produit';
      div.innerHTML = `
        <a href="produit.html?id=${id}" class="lien-produit">
          <img src="${p.image}" alt="${escapeHtml(p.nom)}" />
          <h3>${escapeHtml(p.nom)}</h3>
          <p><strong>${p.prix.toFixed(2)} $</strong></p>
        </a>
      `;
      galerie.appendChild(div);
    });
  })
  .catch(err => console.error('Erreur chargement produits.json :', err));

</script>


<div id="footer-container"></div>

<script>
  fetch('footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer-container').outerHTML = data;
    });
</script>

</body>
</html>
